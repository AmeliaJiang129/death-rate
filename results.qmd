# Results

## Data Source 2:

```{r,fig.height=5.5,fig.width=8}
library(readxl)
library(tidyr)
library(dplyr)
library(ggplot2)
library(dplyr)
library(redav)
library(plotly)
library(vcd)
library(colorspace)
```

```{r}
# Read data from excel
file_path <- "data/clean/ghecode_cleaned_2.xlsx"
df_2 <- data.frame()
for (sheet_name in excel_sheets(file_path)) {
  current_sheet <- read_excel(file_path, sheet = sheet_name)
  df_2 <- bind_rows(df_2, current_sheet)
}

# Data format conversion and preprocessing 
df_2$cause[df_2$cause == 'Communicable, maternal, perinatal and nutritional conditions'] <- 'Communicable & Nutritional'
df_2$cause[df_2$cause == 'Noncommunicable diseases'] <- 'Noncommunicable'
df_2_long <- pivot_longer(df_2,cols = '0-28 days':'70+ years', names_to = "age_group", values_to = "death_num")
df_2_long$age_group <- factor(df_2_long$age_group, levels = c("0-28 days", "1-59 months", "5-14 years", "15-29 years", "30-49 years", "50-59 years", "60-69 years","70+ years"))
df_2_long$sex <-factor(df_2_long$sex, levels = c("Male","Female"))

```

First, we analyze the change over time in the number of deaths of different causes on a global scale. It is noted that there is an upward trend in the number of deaths globally as a whole. In particular, deaths from non-communicable diseases are the main source of the rise in the number of deaths from all factors, while deaths from communicable diseases and problems such as malnutrition show a downward trend. The overall number of casualties is relatively stable and hardly changes over time.

```{r,fig.height=5.5,fig.width=10}

df_2_long_1<-df_2_long %>%
  filter(level == 1)

df_2_long_1$cause <-factor(df_2_long_1$cause, levels = c("Injuries","Communicable & Nutritional","Noncommunicable"))

ggplot(df_2_long_1,aes(x = year, y = death_num, fill = cause)) +
  geom_bar(stat = "identity") +
  labs(title = "Stacked Bar Chart of Death Num",
       x = "Year",
       y = "Death Num") +
  theme_minimal()

```

In terms of specific regions, Wpr and Sear had the highest number of deaths, while Amr and Emr had the lowest. In terms of changes in the number of deaths by region, Wpr, Emr and Amr show an upward trend, Afr shows a downward trend, and Sear and Eur remain more or less unchanged. For Wpr, Emr and Amr, where the number of deaths increased, noncommunicable disease was the most important source of increase. For Afr, where the overall number of deaths has declined, it is noted that a significant decline in deaths due to infectious diseases and malnutrition is the main reason for the overall decline, which even outweighs the rise in noncommunicable factors, resulting in a downward trend in the overall number of deaths.

```{r,fig.height=10,fig.width=10}

df_2_long_1<-df_2_long %>%
  filter(level == 1)
df_2_long_1$year <-factor(df_2_long_1$year, levels = c("2019","2015", "2010","2000"))
df_2_long_1$region <-factor(df_2_long_1$region, levels = c("Wpr","Sear","Eur",'Afr','Amr','Emr'))
df_2_long_1$cause <-factor(df_2_long_1$cause, levels = c("Injuries","Communicable & Nutritional","Noncommunicable"))

ggplot(df_2_long_1,aes(x = year, y = death_num, fill = cause)) +
  geom_bar(stat = "identity") +
  labs(title = "Stacked Bar Chart of Death Num",
       x = "Year",
       y = "Death Num") +
  facet_wrap(~region, ncol = 1)+
  coord_flip() +
  theme_minimal()

```


By gender, the overall number of deaths is higher for males than for females, and both show an upward trend over time. It is noted that for both gender groups, the number of deaths from noncommunicable disease is increasing, and the number of deaths from both communicable and nutritional causes is decreasing. It is also noteworthy that there are significantly more deaths from injuries and noncommunicable disease among males than females.


```{r,fig.height=8,fig.width=8}

df_2_long_1<-df_2_long %>%
  filter(level == 1)
df_2_long_1$year <-factor(df_2_long_1$year, levels = c("2019","2015", "2010","2000"))
df_2_long_1$region <-factor(df_2_long_1$region, levels = c("Wpr","Sear","Eur",'Afr','Amr','Emr'))
df_2_long_1$cause <-factor(df_2_long_1$cause, levels = c("Injuries","Communicable & Nutritional","Noncommunicable"))

ggplot(df_2_long_1,aes(x = year, y = death_num, fill = cause)) +
  geom_bar(stat = "identity") +
  labs(title = "Stacked Bar Chart of Death Num",
       x = "Year",
       y = "Death Num") +
  facet_wrap(~sex, ncol = 1)+
  coord_flip() +
  theme_minimal()

```


The following analysis of the 2019 data analyzes whether there is an interaction relationship between the number of deaths in different regions, ages, and sexes.

First note that the age composition of deaths is characterized differently across region. Afr and Emr have more young people in their death cohorts. Especially for Afr, the number of deaths under 15 accounts for almost half of the overall number of deaths, which may be related to the health care conditions in the region. For Amr, Wpr and Eur, on the other hand, the age group over 69 accounted for the majority of the overall number of deaths.


```{r}

df_2_long_2019<-df_2_long %>%
  filter(year == 2019)%>%
  filter(level == 1)

df_2_long_2019$region <-factor(df_2_long_2019$region, levels = c('Afr','Emr',"Sear",'Amr',"Wpr","Eur"))
df_2_long_2019$age_group <- as.factor(df_2_long_2019$age_group)
df_2_long_2019$sex <- as.factor(df_2_long_2019$sex)

df_2_long_2019 <- df_2_long_2019 %>%
  mutate(age_group2 = case_when(
    age_group %in% c("0-28 days", "1-59 months", "5-14 years") ~ "<15",
    age_group %in% c("30-49 years", "15-29 years") ~ "15-49",
    age_group %in% c("50-59 years", "60-69 years") ~ "50-69",
    TRUE ~ "70+"
  ))
df_2_long_2019$cause <-factor(df_2_long_2019$cause, levels = c("Communicable & Nutritional","Noncommunicable","Injuries"))

colnames(df_2_long_2019)[colnames(df_2_long_2019) == "death_num"] <- "Freq"

mosaic(age_group2~region,data=df_2_long_2019,highlighting_fill=c("#F1F1F1","#A7C6DD","#7C7BB2","#6B0077"),direction=c('v','h'))

```

It is also noted that the age distribution within the groups of people who died due to different causes varies. The adolescent group accounts for a larger proportion of deaths due to infectious diseases and malnutrition, while the 70+ age group accounts for a larger proportion of deaths due to noncommunicable diseases. Deaths from accidental injuries and deaths are almost evenly distributed across age groups.

```{r,fig.height=6,fig.width=6}
mosaic(age_group2 ~ cause,
       data = df_2_long_2019,
       highlighting_fill = c("#F1F1F1", "#A7C6DD","#7C7BB2", "#6B0077"),
       direction = c('v', 'h'),
       rot_labels = c(0,0,0,90),
       fontsize=2)

```


The gender distribution is almost even across age and regional divisions.


```{r}
mosaic(sex~age_group2,data=df_2_long_2019,highlighting_fill=c("#A7C6DD","#6B0077"),direction=c('v','h','h'))
mosaic(sex~region,data=df_2_long_2019,highlighting_fill=c("#A7C6DD","#6B0077"),direction=c('v','h'))

```

Below, we analyze the causes of death more specifically. In the above analysis, we simply categorized the causes of death into three main categories-communicable & nutritional, noncommunicable, and injuries-and now we will break them down more closely to find the major causes of death in each category. 

Among noncommunicable diseases, Cardiovascular diseases, Malignant neoplasms and Respiratory diseases are the top 3 causes for death. Among communicable & nutritional reasons, Infectious diseases are the top 3 causes for death. Among communicable & nutritional reasons, Infectious and parasitic diseases, Neonatal conditions and Respiratory Infectious are the top 3 causes for death. For injuries, unintentional diseases are the top 3 causes. For injuries, unintentional injuries and deaths account for a higher proportion of deaths and injuries than intentional injuries and deaths.

Also note that the percentage of age in the different factors varies, an observation that is the same as the mosaic plot findings above.

```{r,fig.height=8,fig.width=10}

# 筛选出所有code的字符串长度等于2位的数据，建立新表
filtered_data <- df_2_long %>%
  filter(nchar(code) == 2)

filtered_data <- filtered_data %>%
  mutate(father_cause = case_when(
    substr(code, 1, 1) == "1" ~ 'Communicable & Nutritional',
    substr(code, 1, 1) == "2" ~ df_2_long$cause[df_2_long$code == "2"][1],
    substr(code, 1, 1) == "3" ~ df_2_long$cause[df_2_long$code == "3"][1],
  ))

filtered_data <- filtered_data %>%
  mutate(age_group2 = case_when(
    age_group %in% c("0-28 days", "1-59 months", "5-14 years", "15-29 years") ~ "<30 years",
    age_group %in% c("30-49 years") ~ "30-49 years",
    age_group %in% c("50-59 years", "60-69 years") ~ "50-69 years",
    TRUE ~ "70+ years"
  ))

filtered_data$father_cause <-factor(filtered_data$father_cause, levels = c("Noncommunicable","Communicable & Nutritional","Injuries"))

library(lattice)

filtered_data %>%
  group_by(cause,age_group2) %>%
  mutate(death_sum = sum(death_num)) %>%
  ggplot( aes(x = reorder(cause, death_sum), y = death_sum, color = age_group2)) +
  geom_point(position = position_dodge(width = 0), size = 2.5 )+
  facet_grid(father_cause ~ ., scales = "free_y",space = "free_y") +
  coord_flip() +
  scale_y_log10()+
  labs(title = "Cleveland Dotplot - Main 2nd-level Causes and Difference on Age Groups",
       x = "Cause",
       y = "Death Number",
       color = "Age Group")+
  theme_minimal()+
  theme(strip.text.y = element_text(angle = 90, hjust = 0.5,size=9))

```

Among the differences in the regional distribution of the different factors, it is noted that Sear, Eur and Wpr contribute the highest number of deaths in noncommunicable causes, while Afr and Sear have a larger share of the dead in communicable as well as nutritional causes.

```{r,fig.height=8,fig.width=10}
filtered_data %>%
  group_by(cause,region) %>%
  mutate(death_sum = sum(death_num)) %>%
  ggplot( aes(x = reorder(cause, death_sum), y = death_sum, color = region)) +
  geom_point(position = position_dodge(width = 0), size = 2.5 )+
  facet_grid(father_cause ~ ., scales = "free_y",space = "free_y") +
  coord_flip() +
  scale_y_log10()+
  labs(title = "Cleveland Dotplot - Main 2nd-level Causes and Difference on Regions",
       x = "Cause",
       y = "Death Number",
       color = "Region") +
  theme_minimal()+
  theme(strip.text.y = element_text(angle = 90, hjust = 0.5,size=9))
```

Finally, we will analyze the similarity of the distribution of causes of death in different geographic areas, with method Pricipal Component Analysis (PCA).

Firstly, according to the data of 2019, Eur, Amr and Emr are more similar in the characteristics of the distribution of causes of death, with a lower number of deaths in all three major categories of causes.Wpr has more deaths due to noncommunicable diseases, Sear has more deaths due to injuries, and Afr has more deaths due to Communicable and nutritional diseases.

```{r}

df_2_long_filtered <- df_2_long %>%
  filter(level == 1)%>%
  filter( year == 2019 )%>%
  mutate(age_group2 = case_when(
    age_group %in% c("0-28 days", "1-59 months", "5-14 years", "15-29 years") ~ "<30 years",
    age_group %in% c("30-49 years") ~ "30-49 years",
    age_group %in% c("50-59 years", "60-69 years") ~ "50-69 years",
    TRUE ~ "70+ years"
  ))

df_2_long_filtered <- df_2_long_filtered %>%
  select(-age_group)%>%
  select(-sex)%>%
  select(-age_group2)

df_2_long_filtered$region <- paste(df_2_long_filtered$region, df_2_long_filtered$year, sep = "_")
df_2_long_filtered <- df_2_long_filtered %>%
  select(- year)

df_2_long_filtered <- df_2_long_filtered %>%
  group_by(cause,region) %>%
  summarise(death_num = sum(death_num))

df_2_shorter <- df_2_long_filtered %>%
  pivot_wider(names_from = cause,values_from = death_num, values_fill=0)

# 假设 df 是你的数据框
constant_columns <- sapply(df_2_shorter, function(col) length(unique(col)) == 1)
df_2_shorter <- df_2_shorter[, !constant_columns]
# 用一个小的非零值替换零值
df_2_shorter[df_2_shorter == 0] <- 1e-10

# PCA biplot
pca_plot<- draw_biplot(df_2_shorter,point_size=1)+
  scale_x_continuous(limits=c(-3,3))+
  scale_y_continuous(limits=c(-4,3))+
  theme_minimal()+
  ggtitle('PCA Analysis - Similarity Comparison across Regions')

ggplotly(pca_plot)
```

Below, the data for 2000 and 2019 are compared to see if the causes of death in different regions have changed trends over the two decades. Notice that the distributions for Eur, Amr, and Emr remain relatively similar, and that Emr and Amr show the same changing trends, i.e., an increase in the share of deaths from noncommunicable diseases and a decrease in deaths from communicable. For Afr, Sear, and Wpr, despite the very unlike characterization of the causes of death for ta, they show the same trend of change from 2000 to 2019 (same direction of panning for all three points). They all had a decrease in the share of deaths due to communicable & nutritional, and an increase in the share of noncommunicable.

```{r}

df_2_long_filtered <- df_2_long %>%
  filter(level == 1)%>%
  filter( year == 2000|year == 2019 )%>%
  mutate(age_group2 = case_when(
    age_group %in% c("0-28 days", "1-59 months", "5-14 years", "15-29 years") ~ "<30 years",
    age_group %in% c("30-49 years") ~ "30-49 years",
    age_group %in% c("50-59 years", "60-69 years") ~ "50-69 years",
    TRUE ~ "70+ years"
  ))

df_2_long_filtered <- df_2_long_filtered %>%
  select(-age_group)%>%
  select(-sex)%>%
  select(-age_group2)

df_2_long_filtered$region <- paste(df_2_long_filtered$region, df_2_long_filtered$year, sep = "_")
df_2_long_filtered <- df_2_long_filtered %>%
  select(- year)

df_2_long_filtered <- df_2_long_filtered %>%
  group_by(cause,region)%>%
  summarise(death_num = sum(death_num))

df_2_shorter <- df_2_long_filtered %>%
  pivot_wider(names_from = cause,values_from = death_num, values_fill=0)

# 假设 df 是你的数据框
constant_columns <- sapply(df_2_shorter, function(col) length(unique(col)) == 1)
df_2_shorter <- df_2_shorter[, !constant_columns]
# 用一个小的非零值替换零值
df_2_shorter[df_2_shorter == 0] <- 1e-10

# PCA biplot
pca_plot<- draw_biplot(df_2_shorter,point_size=1)+
  scale_x_continuous(limits=c(-3,3))+
  scale_y_continuous(limits=c(-4,3))+
  theme_minimal()+
  ggtitle('PCA Analysis - Similarity Comparison across Regions over Time')

ggplotly(pca_plot)
```

